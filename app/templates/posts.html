{% extends "base.html" %}
{% from '_macros.html' import render_post_card, render_pagination with context %}

{% block title %}InstaSave - Saved Posts{% endblock %}

{% block head %}{% endblock %}

{% block content %}
    <h1>Saved Instagram Posts</h1>

    <form method="get" action="/posts" class="flex flex-wrap gap-4 items-center mb-6">
        <input type="text" name="q" value="{{ request.query_params.get('q', '') }}"
               placeholder="Search tags or captions"
               class="input flex-grow" />
        <label for="sortOrder" class="meta">Sort by:</label>
        <select id="sortOrder" name="sort_order" onchange="this.form.submit()" class="input">
            <option value="desc" {% if sort_order == "desc" %}selected{% endif %}>Newest First</option>
            <option value="asc" {% if sort_order == "asc" %}selected{% endif %}>Oldest First</option>
        </select>
        <button type="submit" class="btn btn-primary">Search</button>
    </form>

    {% if posts %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for post in posts %}
                <div class="post-card">
                    {% set paths = post.media_paths if post.media_paths else [] %}
                    <div class='media-gallery'>
                      {% for mp in paths %}
                        {% set media_url = url_for('serve_media_item', code=post.code, idx=loop.index0) %}
                        {% set lower = mp|lower %}
                        {% if lower.endswith('.mp4') or lower.endswith('.webm') or lower.endswith('.mov') %}
                          <video controls style='max-width:100%;border-radius:8px;'><source src='{{ media_url }}'></video>
                        {% else %}
                          <img src='{{ media_url }}' alt='Post media' style='max-width:100%;border-radius:8px;'>
                        {% endif %}
                      {% endfor %}
                    </div>
                    <div class="post-card-caption">
                        <p>{{ post.caption }}</p>
                        <span class="post-card-timestamp">{{ post.timestamp|ts }}</span>
                    </div>
                </div>
            {% endfor %}
        </div>
        {{ render_pagination(current_page, total_pages, query, sort_order) }}
    {% else %}
        <div class="text-center py-12">
            <p class="text-lg text-slate-600 mb-4">No posts found.</p>
            <a href="/scrape" class="btn btn-primary">Scrape for new posts</a>
        </div>
    {% endif %}

    <!-- Lightbox HTML -->
    <div class="lightbox-overlay" id="lightboxOverlay">
        <div class="lightbox-content">
            <a href="#" class="lightbox-close" id="lightboxClose">&times;</a>
            <div id="lightboxMedia"></div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', path='js/posts.js') }}"></script>
{% endblock %}
